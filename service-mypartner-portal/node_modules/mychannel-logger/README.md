# Logger Plugin

[Screen Shot 2560-02-23 at 11.16.08 AM.png](https://trello-attachments.s3.amazonaws.com/58a3cd82334c36810c838d68/58a408c05c6c96ab6b0953a8/93a228a3b034a359be453ea7e623374e/Screen_Shot_2560-02-23_at_11.16.08_AM.png) 

## ข้อมูลและตัวอย่างผลลัพธ์
พัฒนา Plugin สำหรับการใช้งานในการบันทึก Log ของระบบ My Channel โดยประกอบไปด้วย

    - Access Log บันทึกการเรียกใช้งาน API ของแต่ละ URI
    - Info Log บันทึกการเรียกใช้งานและผลลัพธ์ API ของแต่ละ URI
    - Service Log บันทึกการเรียกใช้งาน Backend API
    - Root Log บันทึกการทำงานอื่นๆของระบบ สำหรับนักพัฒนา

** เอกสารเพิ่มเติมอ่านได้จาก T19\_Log\_Description

### Access Log.

บัันทึกการเรียกใช้งาน API ของแต่ละ URI โดยจะทำการบันทึกอัตโนมัติหลังจากทำการติดตั้ง Plugin

ตัวอย่าง
```
2017-02-26 00:00:00.000|htt-/0.0.0.0:3000|192.168.1.1|12345678900987654321|GET|/customerinfo|{"x-api-request-id":"12345678900987654321"}|{}|{}
```

### Info Log.

บัันทึกการเรียกใช้งานและผลลัพธ์ API ของแต่ละ URI โดยจะทำการบันทึกอัตโนมัติหลังจากทำการติดตั้ง Plugin

ตัวอย่าง
```
2017-02-26 00:00:00.000|htt-/0.0.0.0:3000|192.168.1.1|12345678900987654321|GET|/customerinfo|{"x-api-request-id":"12345678900987654321"}|{}|{}|200|{"reusltCode":"000000","description":"success","developerMessage":"success","data":[{},{}]}|100.111
```

### Service Log.

บันทึกการเรียกใช้งาน Backend API โดยทำการบันทีกผ่านคำสั่ง ```server.emit('service', eventData);``` ซึ่งสามารถดูรายละเอียดที่ด้านล่างเอกสาร

ตัวอย่าง
```
2017-02-26 00:00:00.000|htt-/0.0.0.0:3000|192.168.1.1|12345678900987654321|GET|/customerinfo|{"x-api-request-id":"12345678900987654321"}|{}|{}|200|{"reusltCode":"000000","description":"success","developerMessage":"success","data":[{},{}]}|100.111
```

### Root Log.

บันทึกการทำงานอื่นๆของระบบ สำหรับนักพัฒนา โดยผ่านคำสั่ง ```server.log(logMessage);```

ตัวอย่าง
```
2017-02-26 00:00:00.000|htt-/0.0.0.0:3000|192.168.1.1|12345678900987654321|Example Message
```

---

## Installation
```
$ yarn add git+ssh://git@git.onlineosd.com/mychannel/hapi-mychannel-logger.git#1.0.1
หรือ
$ yarn add git+https://git@git.onlineosd.com/mychannel/hapi-mychannel-logger.git#1.0.1
```

## Simple Usage

เมื่อทำการปลั๊กอินติดตั้งระบบจะสามารถบันทึก Access Log และ Info Log โดยอัตโนมัติ

```
import * as Hapi from 'hapi';
import * as Glue from 'glue';

const host = process.env.HOST || '127.0.0.1';
const port = process.env.PORT || 3000;

const manifest = {
    server: {
        debug: {
            request: ['error'],
            log: ['error']
        }
    },
    connections: [
        {
            host: host,
            port: port
        }
    ],
    registrations: [
        {
            plugin: {
                register: 'mychannel-logger',
                options: {
                    log: {
                        path: '/opt/ais-my-channel/logs',
                        rotateTime: 15
                    },
                    headers: [
                        'postman-token', 'user-agent'
                    ],
                    hiddenFields: ['password']
                }
            }
        }
    ]
};

const options = {
    relativeTo: __dirname
};

Glue.compose(manifest, options, (err, server : Hapi.Server) => {
    if (err) {
        throw err;
    }

    server.start(() => {
        server.log("Hello World", server.info);
        console.log('server is runing.');
    });
});

```

## Configuration

#### Composes a plugin object object where:

+ `log` - an object having:
    + `path` - path สำหรับการเก็บไฟล์ log
    + `rotateTime` - ช่วงเวลาของการ rotate file ในหน่วยนาที ตัวอย่าง เช่น 15 
+ `headers` - list ของ header ที่ต้องการนำมาแสดงใน log file ตัวอย่าง เช่น ['postman-token', 'user-agent']
+ `hiddenFields` - list ของ field ใน object ของ payload ที่ไม่ต้องการแสดงค่าในไฟล์ log โดยจะใส่ '***' ในค่าของ field นั้น ตัวอย่าง ['password']

---

## การใช้งาน log ที่มี event 'service'

โดยจะต้องมีการ emit event 'service' โดยใช้คำสั่ง 

```
server.emit('service', eventData);
```

ซึ่งข้อมูลที่ส่งมาพร้อมกับ event จะมีรูปแบบตาม object ด้านล่าง

```
    {
        name: '',       // service name
        timestamp: "111111111",
        request: {
            id: "",
            ip: "",
            apiRequestId: "",
            method: "",
            uri: "",
            headers: [],
            params: [],
            body: {}
        },
        response: {
            status: "",
            body: "",
            time: ""
        },
        error: {
            message: "",
            instance: ""
        }
    };
```