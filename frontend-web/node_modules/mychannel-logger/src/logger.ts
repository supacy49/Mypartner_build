import * as winston from 'winston';
import * as mkdirp from 'mkdirp';
import * as path from 'path';
import * as Moment from "moment";

import { ILogOption, IInfoLog, IAccessLog, IRootLog, IServiceLog } from "./interfaces";
import { LoggerFormat } from './format';

export default class Logger {
    private timestampFormat: string = "YYYYMMDD_HHmm";
    private loggerFormat: LoggerFormat;
    private logOption: ILogOption;

    constructor(logOption: ILogOption) {
        this.loggerFormat = new LoggerFormat(null, null);
        this.logOption = logOption;
    }

    public accessLog = (message: IAccessLog): void => {
        let logger: winston.LoggerInstance = this.createLogger('access', null);
        logger.info(this.loggerFormat.accessLogFormat(message));
        logger.close();
    }

    public infoLog = (message: IInfoLog): void => {
        let logger: winston.LoggerInstance = this.createLogger('info', null);
        logger.info(this.loggerFormat.infoLogFormat(message));
        logger.close();
    }

    public rootLog = (message: IRootLog): void => {
        let logger: winston.LoggerInstance = this.createLogger('root', null);
        logger.info(this.loggerFormat.rootLogFormat(message));
        logger.close();
    }

    public serviceLog = (message: IServiceLog): void => {
        let logger: winston.LoggerInstance = this.createLogger('service', message.name);
        logger.info(this.loggerFormat.serviceLogFormat(message));
        logger.close();
    }

    public emptyLogFormat(logType: string, serviceName: string): string {
        let pipe: string;

        switch (logType) {
            case 'access':
                pipe = `-|-|-|-|-|-|-|-|-|`; //9
                break;
            case 'info':
                pipe = `-|-|-|-|-|-|-|-|-|-|-|-|`; //12
                break;
            case 'root':
                pipe = `|-|-|-|-|`; // 5
                break;
            case 'service':
                pipe = `-|-|-|-|-|-|-|-|-|-|-|-|-|-|`; //14
                break;
            default:
                break;
        }

        let logger: winston.LoggerInstance = this.createLogger(logType, serviceName);
        logger.info(pipe);
        logger.close();
        return pipe;
    }

    private createLogger = (logType: string, serviceName: string): winston.LoggerInstance => {
        let _timestamp: string = this.getTimestamp();
        let dirPath: string = path.join(this.logOption.path, logType, (serviceName || ''));
        mkdirp.sync(dirPath);

        return new winston.Logger({
            transports: [
                new (winston.transports.File)({
                    filename: `${serviceName || logType}.log.${_timestamp}`,
                    dirname: dirPath,
                    json: false,
                    formatter: (options: any): string => {
                        return options.message ? options.message : '';
                    }
                })
            ]
        });
    }

    private getTimestamp = (): string => {
        let timestamp: Moment.Moment = Moment();
        let minute: number = timestamp.minute();
        minute = (Math.floor(minute / this.logOption.rotateTime) * this.logOption.rotateTime);
        timestamp.minute(minute);
        return timestamp.format(this.timestampFormat);
    }
}